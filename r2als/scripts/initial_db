#!/usr/bin/env python
'''
initial_db
Description#   Initialize a database and test case
Developer#     Thada Wangthammang
'''
import os
import sys
import pymongo
import pprint

from r2als import models
from r2als import config as cf
from r2als.scripts import convert_curriculum as cc

default_categories = ['lecture', 'lab','project']
coe_curriculum_data = {
    'faculty': 'Engineering',
    'department': 'Computer Engineering',
    'year': 2553
}
# Not check key yet
raw_subjects = cc.CsvToModel().process('../data/coe_2553_curriculum.csv')

pp = pprint.PrettyPrinter(indent=4)
# pp.pprint(raw_subjects )

if __name__ == '__main__':
    # if len(argv) != 2:
    #     usage(argv)
    # config_uri = argv[1]
    # setup_logging(config_uri)
    # settings = get_appsettings(config_uri)

    models.initial({'mongodb.db_name':cf.Config.db_name,'mongodb.host':cf.Config.host,'mongodb.is_reset':cf.Config.is_reset})

    print ("Initial a database")
    ####################################################

    print ("create default categories")
    for category in default_categories:
        category_tmp = models.Category.objects(name=category).first()
        if not category_tmp:
            category_tmp = models.Category()
            category_tmp.name = category
            category_tmp.save()
        else:
            print("The default categories is exist")

    ####################################################

    print("create CoE 2553 curriculum")
    coe_curriculum = models.Curriculum()
    for key in coe_curriculum_data.keys():
        coe_curriculum[key] = coe_curriculum_data[key]
    coe_curriculum.save()

    ####################################################

    print("create subjects in CoE 2553 curriculum and relationship between subjects")
    for raw_subject in raw_subjects:

        subject_tmp = models.Subject()

        # add a simple data
        if 'code' in raw_subject: subject_tmp.code = raw_subject['code']
        subject_tmp.name = raw_subject['name']
        subject_tmp.credit = int(raw_subject.get('credit', '0'))
        # add curriculum
        subject_tmp.curriculum = coe_curriculum

        # add link to another object
        # add categories
        for category in raw_subject['categories']:
            subject_tmp.categories.append(models.Category.objects(name=category).first())

        subject_tmp.save()

    # link all prerequisite subject
    print("Link all prerequisite subject")
    for raw_subject in raw_subjects:

        if 'code' in raw_subject:
            subject_code = models.Subject.objects(code=raw_subject['code']).first()
        if 'studied_prerequisite' in raw_subject:
            for sp_code in raw_subject['studied_prerequisite']:
                subject_code.studied_prerequisite.append(models.Subject.objects(code=sp_code).first())
        if 'passed_prerequisite' in raw_subject:
            for pp_code in raw_subject['passed_prerequisite']:
                subject_code.passed_prerequisite.append(models.Subject.objects(code=pp_code).first())
        if 'corequisite' in raw_subject:
            for cr_code in raw_subject['corequisite']:
                subject_code.corequisite.append(models.Subject.objects(code=cr_code).first())
        if 'cocurrent' in raw_subject:
            for cc_code in raw_subject['cocurrent']:
                subject_code.corequisite.append(models.Subject.objects(code=cc_code).first())

        subject_code.save()


    #initial test cases

    #add a member
    print("Add Thongdee Mana")
    member_tmp = models.Member()
    member_tmp.id = '5510110999'
    member_tmp.name = 'Thongdee Mana'
    member_tmp.curriculum = coe_curriculum
    member_tmp.save()

    #add dummy data
